<?php

namespace app\controllers;

use app\core\Application;
use app\core\Controller;
use app\models\Post;
use app\core\Request;

class PostController extends Controller
{
    public function create(Request $request)
    {
        $post = new Post();

        // Fetch logged-in technician's ID from session
        $techID = Application::$app->session->get('technician');
        if ($techID) {
            $post->tech_id = $techID;
        } else {
            // Set flash message and redirect if not logged in
            Application::$app->session->setFlash('error', 'You must be logged in to create a post.');
            Application::$app->response->redirect('/technician-login');
            return;
        }

        if ($request->isPost()) {
            $post->loadData($request->getBody());

            if ($post->validate() && $post->save()) {
                Application::$app->session->setFlash('success', 'Post uploaded successfully!');
                Application::$app->response->redirect('/technician-community');
                return;
            }
        }

        return $this->render('/technician/technician-create-post', [
            'model' => $post
        ]);
    }

    public function index()
    {
        $posts = Post::getAllPosts();  // Fetch all posts from the database
        return $this->render('/technician/technician-community', [
            'posts' => $posts
        ]);
    }
}

